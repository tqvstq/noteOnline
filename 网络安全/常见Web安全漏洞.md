# 常见Web安全漏洞
## XSS攻击
> XSS (Cross-Site Scripting)，跨站脚本攻击，因为缩写和 CSS重叠，所以只能叫 XSS。跨站脚本
> 攻击是指通过存在安全漏洞的Web网站注册用户的浏览器内运行非法的HTML标签或JavaScript进
> 行的一种攻击。
>
> 跨站脚本攻击有可能造成以下影响:
> 1. 利用虚假输入表单骗取用户个人信息。
> 2. 利用脚本窃取用户的Cookie值，被害者在不知情的情况下，帮助攻击者发送恶意请求。
> 3. 显示伪造的文章或图片。

XSS 的原理是恶意攻击者往 Web 页面里插入恶意可执行网页脚本代码，当用户浏览该页之时，
嵌入其中 Web 里面的脚本代码会被执行，从而可以达到攻击者盗取用户信息或其他侵犯用户安全
隐私的目的。
XSS 的攻击方式千变万化，但还是可以大致细分为几种类型。
列如
1. 非持久型 XSS（反射型 XSS ）
非持久型 XSS 漏洞，一般是通过给别人发送带有恶意脚本代码参数的 URL，当 URL 地址被打开
时，特有的恶意代码参数被 HTML 解析、执行。
![XSS攻击1](常见Web安全漏洞资料\XSS攻击1.png)
例如
```js
<select>
    <script>
        document.write(''
            + '<option value=1>'
            + location.href.substring(location.href.indexOf('default=') + 8)
            + '</option>'
        );
        document.write('<option value=2>English</option>');
    </script>
</select>
```

2. 持久型 XSS（存储型 XSS）
持久型 XSS 漏洞，一般存在于 Form 表单提交等交互功能，如文章留言，提交文本信息等，黑客
利用的 XSS 漏洞，将内容经正常功能提交进入数据库持久保存，当前端页面获得后端从数据库中
读出的注入代码时，恰好将其渲染执行。
![XSS攻击1](常见Web安全漏洞资料\XSS攻击2.png)
例如
```js
<script>alert(1)</script>
```

**防范办法**
1. Web 页面渲染的所有内容或者渲染的数据都必须来自于服务端。
2. 尽量不要从 URL，document.referrer，document.forms 等这种 DOM API 中获取数据直接渲
染。
3. 尽量不要使用 eval, new Function()，document.write()，document.writeln()，
window.setInterval()，window.setTimeout()，innerHTML，document.createElement() 等
可执行字符串的方法。
4. 如果做不到以上几点，也必须对涉及 DOM 渲染的方法传入的字符串参数做 escape 转义。
5. 前端渲染的时候对任何的字段都需要做 escape 转义编码。
6. CSP 本质上就是建立白名单，开发者明确告诉浏览器哪些外部资源可以加载和执行。我们只需要
配置规则，如何拦截是由浏览器自己实现的。我们可以通过这种方式来尽量减少 XSS 攻击。
7. 用户的输入永远不可信任的，最普遍的做法就是转义输入输出的内容，对于引号、尖括号、斜杠
进行转义后存储(对于富文本防止格式问题建立使用白名单过滤)
8. HttpOnly Cookie  Web应用程序在设置cookie时，将其属性设
为HttpOnly，就可以避免该网页的cookie被客户端恶意JavaScript窃取，保护用户cookie信息。


## SQL注入攻击
>SQL注入：利用现有应用程序，将（恶意）的SQL命令注入到后台数据库执行一些恶意的
 作。
 造成SQL注入的原因是因为程序没有有效过滤用户的输入，使攻击者成功的向服务器提交恶意的SQL查询代码，程序在接收后错误的将攻击者的输入作为查询语句的一部分执行，导致原始的查询逻辑被改变，额外的执行了攻击者精心构造的恶意代码
> 1. 越权获取敏感数据，获取超级账号和密码甚至整个数据库进行脱库
> 2. 能够非法获取服务器权限
> 3. 植入Webshell，获取服务器后门
> 4. 读取服务器敏感文件
>

**防范办法**
1. 不要使用拼接SQL语句方式、最好使用预编译方式，在mybatis编写sql语句的时候，最好使用?传参数方式，不要使用#传参数，因为#传参数方式，可能会受到sql语句攻击。
2. 限制Web应用的数据库的操作权限，给此用户提供仅仅能够满足其工作的最低权限，从
而最大限度的减少注入攻击对数据库的危害。
3. 后端代码检查输入的数据是否符合预期，严格限制变量的类型，例如使用正则表达式进行一
些匹配处理。
4. 字符串长度验证，仅接受指定长度范围内的变量值。sql注入脚本必然会大大增加输入变量的
长度，通过长度限制，比如用户名长度为 8 到 20 个字符之间，超过就判定为无效值。
5. 对进入数据库的特殊字符（'，"，，<，>，&，*，; 等）进行转义处理，或编码转换。基本上
所有的后端语言都有对字符串进行转义处理的方法，比如 lodash 的 lodash._escapehtmlchar
库。
6. \# 符号能够防止SQL注入， $符号无法防止SQL注入，$ 符号一般用于传入数据库对
象，例如传入表名



## CSRF攻击
>用户在登陆后未退出的情况下,访问危险网站,危险网站对未退出的网站进行请求,携带了用户的登陆信息
>
 CSRF攻击,过程如图
 ![XSS攻击1](常见Web安全漏洞资料\CSRF跨站攻击1.jpg)

**防范办法**
1. Get 请求不对数据进行修改
2. 不让第三方网站访问到用户 Cookie
3. 阻止第三方网站请求接口
4. 请求时附带验证信息，比如验证码或者 Token
常用办法
1. SameSite
可以对 Cookie 设置 SameSite 属性。该属性表示 Cookie 不随着跨域请求发送，可以很大程度减
少 CSRF 的攻击，但是该属性目前并不是所有浏览器都兼容。
2. Referer Check
HTTP Referer是header的一部分，当浏览器向web服务器发送请求时，一般会带上Referer信息告
诉服务器是从哪个页面链接过来的，服务器籍此可以获得一些信息用于处理。可以通过检查请求
的来源来防御CSRF攻击。正常请求的referer具有一定规律，如在提交表单的referer必定是在该页
面发起的请求。所以通过检查http包头referer的值是不是这个页面，来判断是不是CSRF攻击但在某些情况下如从https跳转到http，浏览器处于安全考虑，不会发送referer，服务器就无法进行
check了。若与该网站同域的其他网站有XSS漏洞，那么攻击者可以在其他网站注入恶意脚本，受
害者进入了此类同域的网址，也会遭受攻击。出于以上原因，无法完全依赖Referer Check作为防
御CSRF的主要手段。但是可以通过Referer Check来监控CSRF攻击的发生。
3. Anti CSRF Token
目前比较完善的解决方案是加入Anti-CSRF-Token。即发送请求时在HTTP 请求中以参数的形式加
入一个随机产生的token，并在服务器建立一个拦截器来验证这个token。服务器读取浏览器当前
域cookie中这个token值，会进行校验该请求当中的token和cookie当中的token值是否都存在且相
等，才认为这是合法的请求。否则认为这次请求是违法的，拒绝该次服务。
这种方法相比Referer检查要安全很多，token可以在用户登陆后产生并放于session或cookie中，
然后在每次请求时服务器把token从session或cookie中拿出，与本次请求中的token 进行比对。由
于token的存在，攻击者无法再构造出一个完整的URL实施CSRF攻击。但在处理多个页面共存问
题时，当某个页面消耗掉token后，其他页面的表单保存的还是被消耗掉的那个token，其他页面
的表单提交时会出现token错误。
4. 验证码
应用程序和用户进行交互过程中，特别是账户交易这种核心步骤，强制用户输入验证码，才能完
成最终请求。在通常情况下，验证码够很好地遏制CSRF攻击。但增加验证码降低了用户的体验，
网站不能给所有的操作都加上验证码。所以只能将验证码作为一种辅助手段，在关键业务点设置
验证码。

## DDOS攻击
>Denial of Service，拒绝服务，即无法及时接收并处理外界合法请求。
>DoS攻击：指造成DoS的攻击行为，目的是使攻击目标计算机无法提供正常的服务。最常见的
DoS攻击有计算机网络带宽攻击和连通性攻击。其中，带宽攻击是指以极大通信量冲击通往目标
计算机的网络，使得所有可用网络资源都被消耗殆尽，导致合法的用户请求无法通过，无法到达
目标计算机。而连通性攻击则是指用大量的连接请求攻击目标计算机，使得所有可用的操作系统
资源都被消耗殆尽，导致目标计算机无法处理合法用户的请求。
DDoS攻击：DDoS即Distributed Denial of Service，DDoS攻击即是分布式DoS攻击。攻击者借助
客户/服务器技术，控制并利用多个傀儡机（肉鸡），对一个或多个攻击目标发起DDoS攻击，从
而成倍地提高DoS攻击的威力。
DRDoS攻击：DRDoS即Distributed Reflection Denial of Service，DRDoS攻击即是分布式反射
DoS攻击。DRDoS攻击与DoS攻击、DDoS攻击不同，它不是直接对攻击目标发起请求，而是通
过IP欺骗，发送大量源IP地址为攻击目标IP地址的数据包给攻击主机（第三方），然后攻击主机对
IP地址源（即攻击目标）做出大量回应，从而形成DoS攻击。攻击者往往会选择那些响应包远大
于请求包的第三方服务来利用，以达到放大反射攻击的效果，这样的服务包括DNS、NTP、
SSDP、Chargen、Memcached等。

常见攻击方式
1. 死亡之ping (ping of death)
ICMP(InternetControlMessageProtocol，Internet控制信息协议)在Internet上用于错误处理和传
递控制信息。它的功能之一是与主机联系，通过发送一个“回音请求”（echorequest）信息包看看
主机是否“活着”。最普通的ping程序就是这个功能。而在TCP/IP的RFC文档中对包的最大尺寸都有
严格限制规定，许多操作系统的TCP/IP协议栈都规定ICMP包大小为64KB，且在对包的标题头进
行读取之后，要根据该标题头里包含的信息来为有效载荷生成缓冲区。"Ping of Death"就是故意产
生畸形的测试Ping（PacketInternetGroper）包，声称自己的尺寸超过ICMP上限，也就是加载的
尺寸超过64KB上限，使未采取保护措施的网络系统出现内存分配错误，导致TCP/IP协议栈崩溃，
最终接收方宕机。
2. 泪滴 (tear drop)
泪滴攻击利用在TCP/IP协议栈实现中信任IP碎片中的包的标题头所包含的信息来实现自己的攻
击。IP分段含有指示该分段所包含的是原包的哪一段的信息，某些TCP/IP协议栈（例如NT在
servicepack4以前）在收到含有重叠偏移的伪造分段时将崩溃。
3. UDP泛洪(UDP flood)
UDPflood攻击：如今在Internet上UDP（用户数据包协议）的应用比较广泛，很多提供WWW和
Mail等服务设备通常是使用Unix的服务器，它们默认打开一些被黑客恶意利用的UDP服务。如
echo服务会显示接收到的每一个数据包，而原本作为测试功能的chargen服务会在收到每一个数据
包时随机反馈一些字符。UDPflood假冒攻击就是利用这两个简单的TCP/IP服务的漏洞进行恶意攻
击，通过伪造与某一主机的Chargen服务之间的一次的UDP连接，回复地址指向开着Echo服务的
一台主机，通过将Chargen和Echo服务互指，来回传送毫无用处且占满带宽的垃圾数据，在两台
主机之间生成足够多的无用数据流，这一拒绝服务攻击飞快地导致网络可用带宽耗尽。
4. SYN泛洪(SYNflood)
SYNflood攻击：我们知道当用户进行一次标准的 TCP（TransmissionControlProtocol）连接
时，会有一个3次握手过程。首先是请求服务方发送一个 SYN（SynchronizeSequenceNumber）
消息，服务方收到SYN后，会向请求方回送一个SYN-ACK表示确认，当请求方收到 SYN-ACK
后，再次向服务方发送一个ACK消息，这样一次TCP连接建立成功。“SYNFlooding”则专门针对
TCP协议栈在两台主机间初始化连接握手的过程进行DoS攻击，其在实现过程中只进行前2个步
骤：当服务方收到请求方的SYN-ACK确认消息后，请求方由于采用源地址欺骗等手段使得服务方
收不到ACK回应，于是服务方会在一定时间处于等待接收请求方ACK消息的状态。而对于某台服
务器来说，可用的TCP连接是有限的，因为他们只有有限的内存缓冲区用于创建连接，如果这一
缓冲区充满了虚假连接的初始信息，该服务器就会对接下来的连接停止响应，直至缓冲区里的连
接企图超时。如果恶意攻击方快速连续地发送此类连接请求，该服务器可用的TCP连接队列将很
快被阻塞，系统可用资源急剧减少，网络可用带宽迅速缩小，长此下去，除了少数幸运用户的请
求可以插在大量虚假请求间得到应答外，服务器将无法向用户提供正常的合法服务。
5. Land（LandAttack）攻击
在Land攻击中，黑客利用一个特别打造的SYN包--它的原地址和目标地址都被设置成某一个服
务器地址进行攻击。此举将导致接受服务器向它自己的地址发送SYN-ACK消息，结果这个地址又
发回ACK消息并创建一个空连接，每一个这样的连接都将保留直到超时，在Land攻击下，许多
UNIX将崩溃，NT变得极其缓慢（大约持续五分钟）。
6. IP欺骗dos攻击
这种攻击利用TCP协议栈的RST位来实现，使用IP欺骗，迫使服务器把合法用户的连接复位，
影响合法用户的连接。假设现在有一个合法用户（100.100.100.100）已经同服务器建立了正常的
连接，攻击者构造攻击的TCP数据，伪装自己的IP为100.100.100.100，并向服务器发送一个带有
RST位的TCP数据段。服务器接收到这样的数据后，认为从100.100.100.100发送的连接有错误，
就会清空缓冲区中已建立好的连接。这时，合法用户100.100.100.100再发送合法数据，服务器就
已经没有这样的连接了，该用户就被拒绝服务而只能重新开始建立新的连接。
7. Smurf攻击
Smurf是一种简单但有效的DDoS攻击技术，它利用了ICMP(Internet控制信息协议）。ICMP在
Internet上用于错误处理和传递控制信息。它的功能之一是与主机联系，通过发送一个“回音请求”
（echo request）信息包看看主机是否“活着”。最普通的ping程序就使用了这个功能。Smurf是用
一个偷来的帐号安装到一个计算机上的，然后用一个伪造的源地址连续ping一个或多个计算机网
络，这就导致所有计算机所响应的那个计算机并不是实际发送这个信息包的那个计算机。这个伪
造的源地址，实际上就是攻击的目标，它将被极大数量的响应信息量所淹没。对这个伪造信息包
做出响应的计算机网络就成为攻击的不知情的同谋。


**防范办法**
1. SYN Flood攻击
原理：问题就出在TCP连接的三次握手中，假设一个用户向服务器发送了SYN报文后突然死机或掉
线，那么服务器在发出SYN+ACK应答报文后是无法收到客户端的 ACK报文的（第三次握手无法
完成），这 种情况下服务器端一般会重试（再次发送SYN+ACK给客户端）并等待一段时间后丢
弃这个未完成的连接，这段时间的长度我们称为SYN Timeout，一般来说这个时间是分钟的数量
级（大约为30秒 -2分钟）；一个用户出现异常导致服务器的一个线程等待1分钟并不是什么很大的
问题，但如果有一个恶意的攻击者大量模拟这种情况，服务器端将为了维护一个 非常大的半连接
列表而消耗非常 多的资源----数以万计的半连接，即使是简单的保存并遍历也会消耗非常多的CPU
时间和内存，何况还要不断对这个列表中的IP进行SYN+ACK的重试。实际上如果服务器的TCP/IP
栈不够强大，最后的结果往往是堆栈溢出崩溃---即使服务器端的系统足够强大，服务器端也将忙
于处理攻击者伪造的TCP连接请求而无暇理睬客户的正常请求（毕竟客户端的正常请求比率非常
之小），此时从正常客户的角度看来，服务器失去响应，这种情况我们称作：服务器端受到了
SYN Flood攻击（SYN洪水攻击）。
防范：
第一种是缩短SYN Timeout时间
第二种方法是设置SYN Cookie，就是给每一个请求连接的IP地址分配一个Cookie，如果短时间
内连续受到某个IP的重复SYN报文，就认定是受到了攻击，以后从这个IP地址来的包会被一概丢
弃。
>netstat -n -p tcp >result.txt
2. Smurf攻击：
原理:发送伪装的ICMP数据包，目的地址设为某个网络的广播地址，源地址设为要攻击的目的主机，
使所有收到此ICMP数据包的主机都将对目的主机发出一个回应，使被攻击主机在某一段时间内收
到成千上万的数据包
防范：
在cisco路由器上配置如下可以防止将包传递到广播地址上:
Router(config-if)# no ip directed-broadcast
3. Ping of Death
原理："ping of death"攻击就是我们常说的"死亡Ping"这种攻击通过发送大于65536字节的ICMP包使操作系统崩溃；通常不可能发送大于65536个字节的ICMP包，但可以把报文分割成片段，然后在目标主机上重组；最终会导致被攻击目标缓冲区溢出，引起拒绝服务攻击。有些时候导致telnet和http服务停止，有些时候路由器重启。
4. 泪滴攻击
原理：对于一些大的IP数据包，往往需要对其进行拆分传送，这是为了迎合链路层的MTU（最大传输单元）的要求。比如，一个6000字节的IP包，在MTU为2000的链路上传输的时候，就需要分成3个IP 包。在IP报头中有一个偏移字段和一个拆分标志（MF）。如果MF标志设置为1，则表示这个
IP包是一个大IP包的片段，其中偏移字段指出了这个片段在整 个IP包中的位置。例如，对一个6000字 节的IP包进行拆分（MTU为2 000），则3个片段中偏移字段的值依次为0，2000，4000。这样接收端在全部接收完IP数据包后，就可以根据这些信息重新组装这几个分次接收的拆分IP包。在这 里就有一个安全漏洞可以利用了，就是如果黑客们在截取IP数据包后，把偏移字段设置成不正确的值，这样接收端在收到这些分拆的数据包后，就不能按数据包中 的偏移字段值正确组合这些拆 分的数据包，但接收端会不断尝试，这样就可能致使目标计算机操作系统因资源耗尽而崩溃。
5. DRDOS
原理：攻击时，攻击者巧妙的利用了反弹服务器群来将洪 水数据包反弹给目标主机 反弹服务是指某些服务器在收到一个请求数据报后就会产生一个回应数据报。所有的 Web 服务器、DNS 服务器及路由器都是反弹服务器，他们会对 SYN 报文或其他 TCP 报文回应 SYNACKs 或 RST 报文， 以及对一些 IP 报文回应 ICMP 数据报超时或目的地不可达消息的数据 报。任何用于普通目的 TCP连接许可的网络服务器都可以用做数据包反射服务器

## 点击劫持
>点击劫持是一种视觉欺骗的攻击手段。攻击者将需要攻击的网站通过 iframe 嵌套的方式嵌入自己
的网页中，并将 iframe 设置为透明，在页面中透出一个按钮诱导用户点击。

**防范办法**
1. X-FRAME-OPTIONS
X-FRAME-OPTIONS是一个 HTTP 响应头，在现代浏览器有一个很好的支持。这个 HTTP 响应头 就
是为了防御用 iframe 嵌套的点击劫持攻击。
该响应头有三个值可选，分别是
    - DENY，表示页面不允许通过 iframe 的方式展示
    - SAMEORIGIN，表示页面可以在相同域名下通过 iframe 的方式展示
    - ALLOW-FROM，表示页面可以在指定来源的 iframe 中展示
2. JavaScript 防御
对于某些远古浏览器来说，并不能支持上面的这种方式，那我们只有通过 JS 的方式来防御点击劫
持了，Frame Busting ：这种方式是通过写JavaScript来禁止iframe嵌套，但是可以轻易饶过。


## URL跳转漏洞
>借助未验证的URL跳转，将应用程序引导到不安全的第三方区域，从而导致的安全问题
实现方式
	- Header头跳转
	- Javascript跳转
	- META标签跳转

**防范办法**
1. referer的限制
如果确定传递URL参数进入的来源，我们可以通过该方式实现安全限制，保证该URL的有效性，
避免恶意用户自己生成跳转链接
2. 加入有效性验证Token,通过在生成的链接里加入用户不可控的Token对生成的链接进行校验,或者进行白名单配置

## session劫持
>首先通过捕获合法用户的session, 然后冒充该用户来访问系统。也就是说，攻击者至少必须要获取到一个有效的session标识符，用于接下来的身份验证。
>

**防范办法**
1. 更改Session名称
2. 设置HttpOnly
3. 关闭透明化Session ID
4. 验证HTTP头部信息
5. 加入Token校验